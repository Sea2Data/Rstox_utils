---
title: "Reproduction of eca estimates"
author: "Edvin Fuglebakk"
date: "5/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../compare_results_multiple_stox_runs.R")
eca_results <- list()
eca_results$kolmule2017 <- "../kolmule/eca_2017/KOLMULE2017.fit.2017_allgears_totalarea_season1234.caa.txt"
eca_results$makrell2017 <- "../makrell/eca_2017/MAKRELL2017.fit.2017_allgears_totalarea_season1234.caa.txt"
eca_results$sei.nssk.2018 <- "../sei_nssk/eca_2018/SEI2018_ns_v00.fit.2018_allgears_totalarea_season1234.caa.txt"
eca_results$hyse.nssk.2018 <- "../hyse_nssk/eca_2018/HYSE2018_ns_v00.fit.2018_allgears_27fire_season1234.caa.txt"
eca_results$torsk.nssk.2018 <- "../torsk_nssk/eca_2018/TORSK2018_ns_v00.fit.2018_allgears_IV_season1234.caa.txt"
stox_results <- list()
stox_results$kolmule2017 <- "../kolmule/stox_2017/results"
stox_results$makrell2017 <- "../makrell/stox_2017/results"
stox_results$sei.nssk.2018 <- "../sei_nssk/stox_2018/results/"
stox_results$hyse.nssk.2018 <- "../hyse_nssk/stox_2018/results/"
stox_results$torsk.nssk.2018 <- "../torsk_nssk/stox_2018/results/"

```

## Background
ECA 3.x are implementations of The ECA model (Hirst et al. 2004, 2005 and 2012) developed by the Norwegian Computing Centre for IMR. ECA 3.x has been used for catch at age estimations for several species. The Norwegian Computing Centre has developed an new implementation of ECA delivered to IMR and the REDUS project as an R-package which I will refer to as RECA. As part oif the REDUS project an data APIs and a user interface for configuring and running Reca has been implemented in StoX. I will refer to estimates produced via this interfaces as StoX-Reca estimates. The StoX-Reca integration aims to achieve several goals:

* Provide an implementation of ECA that is acceptable for user that have decided on using ECA for catch at age estimates.
* Provide a user interface familiar to StoX users.
* Separate data handling and estimation, so that filtering and transformation are exposed to users.
* Document all model parameters and data versions for purposes of recomputability.

The first StoX-Reca version has been delivered and has been tested during the spring of 2019.

### Design decisions
Some decisions was made during the StoX-Reca implementation that excludes certain model and date configurations possible with the ECA 3.x. 

* It has not yet been implemented a procedure for adjusting landings data with logbook records. A procedure that was supported with separate scripts for ECA 3.x. Adding this to the bookeeping necessary for versioning data is an extra burden, and the value added to the estimates has not been analysed.
* Grouping of covariate values is not supported in StoX-Reca, rather it allows for redefinig variables to differen resolutions. This is more flexible and can in most cases this can mimic grouping.
* Configuring covariates differently for the underlying ECA models ("length given age" and "weight given length") is not supported in StoX-Reca, as this requires grouping covariate values.
* Not all filters that are supported by ECA 3.x are implemented in StoX-Reca. Notably filtering for outliers in the age-length scatter. We have decided we want to flag these as data errors in stead, to be filtered out explicitly or cleaned up in the database.

## Usability testing
Configuring estimates for reproduction has revealed some usability issues that should be considered for further StoX-Reca development.

* The landings format readable by StoX is still only provided via API calls. A user interface in datasetexplorer should be considered.
* At times I found the landings data to be outdated, not reflecting recent corrections from FDIR. A procedure for regularly updating the landings API should be defined.
* Grouping of areas are common in the configurations I have attempted to reproduce. Currently this require generation of new stratafiles and neighbourmatrices in StoX, which is cumbersome for users. A user interface for redefining spatial covariate and neighbour-matrices should be considered. Alternativelty scripts for generating regrouping of common strata systems could be provided
* Some confiugrations use grouping of seasons. Defining odd temporal configurations are not straightforward in StoX, and I had to resort to manipulating the process-file, in order define temporal coviarates spanning several quarters.
* Configuration of reports. It is common to configure ECA to decompose estimates on other covariates then those configured for the model (e.g. configure model for F.dir-areas, and reports for ICES areas). Stox-processes to support that should be considered.
* ECA 3.x reports both total catch and the catch used for estimation. While these are usually the same, filtering out small fractions that precludes preffered model configurations can be desirable. In Stox-Reca this is currently cumbersome to facilitate.
* Estimates for specific stocks often require filtering data by area. If only positions are available, this is best done after stratum is assigned. But this requires filtering on variables added to the data in StoX, which I think is not supported.
* At the end of the prepareRECA process, data checks are performed and reports on potential data issues are compiled. Currently prepareRECA halts on some of these data issues, which precludes the reports from being compiled. Extracting data issue-reporting to a process run prior to prepareRECA should be considered.
* Bug in StoX (STOX-218). Workaround implemented in prepareRECA, but this does not support non-seasonal temporal covaraite.
* Traceplots for inspecting stability of estimates should be considered. Such plots are produced by ECA 3.x.
* Reports on data issues complies report for common covariates, without checking if these are configured. Consider if this can be avoided.

## Reproduction of ECA 3.x results
As part of assuring the quality of the StoX-Reca implementations, I have attempted to configure StoX-Reca projects that mimic ECA 3.x estimates that has been used for advice. I have yet to identify all data and all model configurations from previous ECA 3.x runs. In cases where I have ECA .param files I have near complete description of model configuration, but exactly identifying the data seems impossible. I have in these cases had to tinker with data selection to demonstrate that a reasonable data selection that approximately reproduces previous results can be found. This tinkering boils down to filtering on mission types and sample types. Selection of specific stations have only been done in order to match a complete listing of serial numbers from the ECA 3.x run, when such are available. ECA estimates are however dependent not only on model configuration and data, but also on random parameter exploration in the Monte Carlo simulations. Difference in estimated parameters that are smaller than random differences in parameter exploration does not affect valid interpretations of the results and I will therefore compare ECA 3.x estimates to multiple StoX-Reca estimates, generated with different random seed, and be content with the reproduction if the ECA 3.x estimate does not seem very unlikely given the distribution of StoX-Reca estimates. I have not formulated a formal criteria for reproduction, but will conclude based on inspection of plots. This validation criteria may pass for models that are not configured exactly the same way, which is useful for evaluating whether ECA 3.x feautres not yet implemented needs to be added to StoX-Reca. The validation apporach does however rest upon the assumption that the implementations sensitivity to random seed is acceptable for adaptation of StoX-Reca. This would follow from acceptance of ECA 3.x if ECA 3.x display similar sensitivity. We should inquire with the Norwegian Computing Centre if they have performed that kind of analysis.

Using the criteria outlned above, I aim to reproduce the following estimates:

* blue whiting 2017: Done
* mackerel 2017: Preliminary
* Norwegian Spring Spawning Herring 2017:
* NSSK saithe 2018: Preliminary
* NSSK haddock 2018: Preliminary
* NSSK cod 2018:


I will just give brief descriptions of configurations below. Consult StoX project files for details.

### Reproduction of blue whiting 2017
ECA 3.x estimate from 2017. Model was configured and run by Sondre Aanes and results provided by Are Salthaug. ECA 3.x .param files was not kept. Based on Sondres notes, I have configured the model with only temporal (season) and platform (boat) as covariates, and verified that station selection (serial numbers) was identical between the two estimates. Quarter 2-4 was collapsed to one value. I used samples from HRF (High-seas reference fleet) and commercial samples, and ran 1500 burnin iterations and 500 sampling iterations, with the log-linear growth model.

* Total catch used in ECA 3.x estimate was 399 kt
* Total catch used in StoX-Reca estimae was 399 kt

Both mean estimates and standard deviations from ECA 3.x are consistent with the range of ten estimates from StoX-Reca. I consider this a satisfactory reproduction of the estimates for the 2017 advice.

```{r kolmule means, fig.cap={"Estimates for mean catch in millions per age group of blue whiting in 2017."}, echo=FALSE}

comppar("kolmule2017", "mean")
```

```{r kolmule sd, fig.cap={"standard deviation of marginal posterior distribution of catch in millions per age group of blue whiting in 2017."}, echo=FALSE}

comppar("kolmule2017", "sd")
```

### Reproduction of mackerel 2017
ECA 3.x estimate from 2017. Model was configured and run by Sondre Aanes and results provided by Are Salthaug. ECA 3.x .param files was not kept. Traceplot from ECA 3.x estimate indicate that analysed MCMC-samples were not stable, and estimated numbers does not seem consistent with reasonable individual weights for these total landings. I may have been provided the wrong files. Based on Sondres notes, I have filtered an exact serialnumber list, modelled the temporal covariate as random, and run with 1000 burnin iterations and 500 sampling iterations, using log-linear growth model. As practically all landings were caught with seine, I have run without gear as covariate. 

* Total catch used in ECA 3.x estimate was 222 kt
* Total catch used in StoX-Reca estimae was 222 kt

The ECA 3.x estimates does not seem to be consistent with the Stox-Reca estimates. Before concluding I think it is warranted to investigate the apparent issue with the ECA 3.x estimate.

```{r makrell means, fig.cap={"Estimates for mean catch in millions per age group of mackerel in 2017."}, echo=FALSE}

comppar("makrell2017", "mean")
```

```{r makrell sd, fig.cap={"standard deviation of marginal posterior distribution of catch in millions per age group of mackerel in 2017."}, echo=FALSE}

comppar("makrell2017", "sd")
```

### Reproduction of Norwegian Spring Spawning herring 2017
ECA 3.x estimate from 2017. Model was configured and run by Sondre Aanes and results provided by Are Salthaug. ECA 3.x .param files was not kept. ased on Sondres notes, I have filtered an exact serialnumber list, grouped Gillnet with Trawl, grouped seasons 1 with two and 3 with 4 and run 1000 burnin iterations and 500 sampling iterations with non-linear growth model.

* Total catch used in ECA 3.x estimate was 389 kt
* Total catch used in StoX-Reca estimate was 389 kt

Running this configuration triggered a bug in the RECA library. This has been reported to the Norwegian Computing Centre and Estimates will be revisited when a revised library is delivered.

### Reproduction of saithe NSSK 2018
ECA 3.x estimates were prepared by Åge Fotland who provided results for reproduction analysis. This included ECA 3.x .param files. The ECA 3.x estimates used logbook-adjusted landings and had weight-length model configured with different geargroupings than the age-length model, neither of which is currently supported by StoX-Reca. Parameters extracted from ECA 3.x .param files suggest the model was configured with season and gear as fixed effects, but I did not have enough aged samples in the data compiled for reproduction to configure it like that. I configured the temporal covariate as a random effect in stead.

* Total catch used in ECA 3.x estimate was 40 kt
* Total catch used in StoX-Reca estimate was 40 kt 


```{r sei means, fig.cap={"Estimates for mean catch in millions per age group of saithe in the North Sea and Skagerak 2018."}, echo=FALSE}

comppar("sei.nssk.2018", "mean")
```

```{r sei sd, fig.cap={"standard deviation of marginal posterior distribution of catch in millions per age group of saithe in the North Sea and Skagerak 2018."}, echo=FALSE}

comppar("sei.nssk.2018", "sd")
```

### Reproduction of haddock NSSK 2018
ECA 3.x estimates were prepared by Åge Fotland who provided results for reproduction analysis. This included ECA 3.x .param files. The ECA 3.x estimates used logbook-adjusted landings, which is not currently supported by StoX-Reca. Parameters extracted from ECA 3.x .param files suggest the model was configured with season and gear as fixed effects, but I did not have enough aged samples in the data compiled for reproduction to configure it like that. I configured the temporal covariate as a random effect in stead. The spatial covariate had only one value, such covariates are implicitly dropped by ECA 3.x, so I configured the StoX-Reca esitmate without the spatial covariate.

* Total catch used in ECA 3.x estimate was 1399 t
* Total catch used in StoX-Reca estimate was 1433 t

This discrepancy is probably due to the use of logbook-adjusted landings in ECA 3.x

Running this configuration triggered a bug in the RECA library. This has been fixed by the Norwegian Computing Centre and Estimates will be revisited.

```{r hyse means, fig.cap={"Estimates for mean catch in millions per age group of haddock in the North Sea and Skagerak 2018."}, echo=FALSE}

comppar("hyse.nssk.2018", "mean")
```
```{r hyse sd, fig.cap={"standard deviation of marginal posterior distribution of catch in millions per age group of haddock in the North Sea and Skagerak 2018."}, echo=FALSE}

comppar("sei.nssk.2018", "sd")
```


### Reproduction of cod NSSK 2018
ECA 3.x estimates were prepared by Åge Fotland who provided results for reproduction analysis. This included ECA 3.x .param files. The ECA 3.x estimates used logbook-adjusted landings, which is not currently supported by StoX-Reca. Results were only provided decomposed on ICES area III (Skagerak) and IV (North Sea). I recall from conversation with Åge that coastal regions are excluded from these estimates, so I filtered landings by kysthav-code. I included coastal samples, still. 

#### ICES area IV
Parameters extracted from ECA 3.x .param files suggest the model was configured with season and gear as fixed effects, but I did not have enough samples with weight in the data compiled for reproduction to configure it like that. I configured the temporal covariate as a random effect in stead. I run the analysis for ICES area III and IV separately, rather than decoposing the report. In that case, the spatial covariate had only one value, such covariates are implicitly dropped by ECA 3.x, so I configured the StoX-Reca esitmate without the spatial covariate.

* Total catch used in ECA 3.x estimate was 5133 t
* Total catch used in StoX-Reca estimate was 5197 t

This discrepancy is probably due to the use of logbook-adjusted landings in ECA 3.x

```{r torsk means, fig.cap={"Estimates for mean catch in millions per age group of cod in the North Sea 2018."}, echo=FALSE}

comppar("torsk.nssk.2018", "mean")
```

```{r torsk sd, fig.cap={"standard deviation of marginal posterior distribution of catch in millions per age group of cod in ICES Sub Area 4."}, echo=FALSE}

comppar("torsk.nssk.2018", "sd")
```
